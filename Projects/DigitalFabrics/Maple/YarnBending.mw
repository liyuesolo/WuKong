restart: with(linalg):with(codegen):
toC := proc(expr, file)
try fremove(file) catch: end try:
writeto(file):
C(expr,optimized):
writeto(terminal):
end:

#For initially straight rods without twisting

x := matrix(3,2):



x0 := vector(2, [x[1,1], x[1,2]]):
x1 := vector(2, [x[2,1], x[2,2]]):
x2 := vector(2, [x[3,1], x[3,2]]):

d1 := matadd(x1,-x0):
nrm_d1 := sqrt(dotprod(d1, d1, 'orthogonal')):
d2 := matadd(x2,-x0):
nrm_d2 := sqrt(dotprod(d2, d2, 'orthogonal')):

theta := arccos(-dotprod(d1/nrm_d1, d2/nrm_d2, 'orthogonal')):

W := kb * theta * theta / (u1 - u2):



vx := vector(8,[x0[1],x0[2],x1[1],x1[2],u1, x2[1],x2[2],u2]):

F := grad(-W,vx):
J := jacobian(F,vx):
V := array(1..1):
V[1] := W:


toC(V,"YarnBendV.mcg"):
toC(F,"YarnBendF.mcg"):
toC(J,"YarnBendJ.mcg"):

