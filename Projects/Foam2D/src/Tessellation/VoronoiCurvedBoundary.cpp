#include <igl/triangle/triangulate.h>
// libigl libirary must be included first
#include "Projects/Foam2D/include/Tessellation/Voronoi.h"
#include <iostream>

void Voronoi::getArcBoundaryNode(const VectorXT &v1, const VectorXT &v2, const TV &b0, const TV &b1, const double r,
                                 const int flag, TV &node) {
    assert(v1.rows() == 2 && v2.rows() == 2);

//    double x1 = (v1(0) + v2(0)) / 2;
//    double y1 = (v1(1) + v2(1)) / 2;
//    double x2 = x1 + (v2(1) - v1(1));
//    double y2 = y1 - (v2(0) - v1(0));
//    double x3 = b0(0);
//    double y3 = b0(1);
//    double x4 = b1(0);
//    double y4 = b1(1);
//    double t = ((x4 - x3) * (y1 - y3) - (y4 - y3) * (x1 - x3)) / (-(x4 - x3) * (y2 - y1) + (x2 - x1) * (y4 - y3));
//    double xn = x1 + t * (x2 - x1);
//    double yn = y1 + t * (y2 - y1);
//    node = {xn, yn};

    double v1x = v1(0);
    double v1y = v1(1);
    double v2x = v2(0);
    double v2y = v2(1);
    double x3 = b0(0);
    double y3 = b0(1);
    double x4 = b1(0);
    double y4 = b1(1);

    double xn, yn;
    // @formatter:off
    xn = 0.5e0 * v1x + 0.5e0 * v2x + ((x4 - x3) * (-y3 + 0.5e0 * v1y + 0.5e0 * v2y) - (y4 - y3) * (-x3 + 0.5e0 * v1x + 0.5e0 * v2x)) / (-(x4 - x3) * (-v2x + v1x) + (v2y - v1y) * (y4 - y3)) * (v2y - v1y);
    yn = 0.5e0 * v1y + 0.5e0 * v2y + ((x4 - x3) * (-y3 + 0.5e0 * v1y + 0.5e0 * v2y) - (y4 - y3) * (-x3 + 0.5e0 * v1x + 0.5e0 * v2x)) / (-(x4 - x3) * (-v2x + v1x) + (v2y - v1y) * (y4 - y3)) * (-v2x + v1x);
    // @formatter:on
    node = {xn, yn};
}

void
Voronoi::getArcBoundaryNodeGradient(const VectorXT &v1, const VectorXT &v2, const TV &b0, const TV &b1, const double r,
                                 const int flag, VectorXT &gradX,
                                 VectorXT &gradY) {
    assert(v1.rows() == 2 && v2.rows() == 2);

    double v1x = v1(0);
    double v1y = v1(1);
    double v2x = v2(0);
    double v2y = v2(1);
    double x3 = b0(0);
    double y3 = b0(1);
    double x4 = b1(0);
    double y4 = b1(1);

    // @formatter:off
    double t1, t2, t3, t4, t5, t6, t7, t8, t9, t10, t11, t12, t13, t14, t15, t16, t17, t18, t19, t20,
            t21, t22, t23, t24, t25, t26, t27, t28, t29, t30, t31, t32, t33, t34, t35, t36, t37, t38, t39, t40,
            t41, t42, t43, t44, t45, t46, t47, t48, t49, t50, t51, t52, t53, t54, t55, t56, t57, t58, t59, t60;

    t1 = y4 - y3;
    t2 = x4 - x3;
    t3 = v2x - v1x;
    t4 = v2y - v1y;
    t5 = t4 * t1;
    t6 = t2 * t3 + t5;
    t7 = 0.1e1 / 0.2e1;
    t8 = t7 * (v1y + v2y);
    t9 = t8 - y3;
    t10 = t7 * (v1x + v2x);
    t11 = t10 - x3;
    t1 = -t1 * t11 + t2 * t9;
    t6 = 0.1e1 / t6;
    t5 = -t5 * t6 + 0.1e1;
    t12 = t7 * t5;
    t13 = t1 * pow(t6, 0.2e1) * t4 * t2;
    t1 = t1 * t6;
    t5 = t1 * t5;
    t2 = t7 * t2 * t6 * t4;
    t3 = t1 * t3;
    t6 = t6 * t4;
    t1 = t4 * t1;
    gradX[0] = t12 + t13;
    gradX[1] = t2 - t5;
    gradX[2] = t12 - t13;
    gradX[3] = t2 + t5;
    gradX[4] = t6 * (t3 - t8 + y4);
    gradX[5] = t6 * (t1 + t10 - x4);
    gradX[6] = t6 * (-t3 + t9);
    gradX[7] = -t6 * (t1 + t11);

    t1 = y4 - y3;
    t2 = x4 - x3;
    t3 = v2x - v1x;
    t4 = v2y - v1y;
    t5 = t2 * t3;
    t6 = t1 * t4 + t5;
    t7 = 0.1e1 / 0.2e1;
    t8 = t7 * (v1y + v2y);
    t9 = t8 - y3;
    t10 = t7 * (v1x + v2x);
    t11 = t10 - x3;
    t2 = -t1 * t11 + t2 * t9;
    t6 = 0.1e1 / t6;
    t5 = t5 * t6 - 0.1e1;
    t12 = t2 * t6;
    t13 = t12 * t5;
    t14 = t7 * t1 * t6 * t3;
    t1 = t2 * pow(t6, 0.2e1) * t3 * t1;
    t2 = -t7 * t5;
    t5 = t12 * t3;
    t3 = t6 * t3;
    t4 = t12 * t4;
    gradY[0] = t14 - t13;
    gradY[1] = t2 - t1;
    gradY[2] = t14 + t13;
    gradY[3] = t2 + t1;
    gradY[4] = -t3 * (t5 + y4 - t8);
    gradY[5] = -t3 * (t4 + t10 - x4);
    gradY[6] = t3 * (t5 - t9);
    gradY[7] = t3 * (t4 + t11);
    // @formatter:on
}

void
Voronoi::getArcBoundaryNodeHessian(const VectorXT &v1, const VectorXT &v2, const TV &b0, const TV &b1, const double r,
                                const int flag, MatrixXT &hessX,
                                MatrixXT &hessY) {
    assert(v1.rows() == 2 && v2.rows() == 2);

    double v1x = v1(0);
    double v1y = v1(1);
    double v2x = v2(0);
    double v2y = v2(1);
    double x3 = b0(0);
    double y3 = b0(1);
    double x4 = b1(0);
    double y4 = b1(1);

    int n = 8;
    double hessX_c[n][n];
    double hessY_c[n][n];

    // @formatter:off
    double t1, t2, t3, t4, t5, t6, t7, t8, t9, t10, t11, t12, t13, t14, t15, t16, t17, t18, t19, t20,
            t21, t22, t23, t24, t25, t26, t27, t28, t29, t30, t31, t32, t33, t34, t35, t36, t37, t38, t39, t40,
            t41, t42, t43, t44, t45, t46, t47, t48, t49, t50, t51, t52, t53, t54, t55, t56, t57, t58, t59, t60;

    t1 = y4 - y3;
    t2 = x4 - x3;
    t3 = v2x - v1x;
    t4 = v2y - v1y;
    t5 = t4 * t1;
    t6 = t2 * t3 + t5;
    t7 = 0.1e1 / 0.2e1;
    t8 = t7 * (v1y + v2y);
    t9 = t8 - y3;
    t10 = t7 * (v1x + v2x);
    t11 = t10 - x3;
    t12 = t2 * t9;
    t13 = -t1 * t11 + t12;
    t6 = 0.1e1 / t6;
    t14 = pow(t6, 0.2e1);
    t15 = 0.2e1 * t13;
    t16 = t15 * t6;
    t17 = t16 * t2;
    t18 = t14 * t4;
    t19 = t18 * t2;
    t20 = pow(t1, 0.2e1);
    t21 = pow(t2, 0.2e1);
    t22 = t7 * t6 * ((t21 - t20) * t6 * t4 + t1);
    t23 = t13 * t14;
    t24 = t23 * t2 * (0.2e1 * t5 * t6 - 0.1e1);
    t25 = t24 + t22;
    t20 = t7 * t6 * ((-t21 - t20) * t6 * t4 + t1);
    t26 = -t24 - t20;
    t8 = y4 - t8;
    t27 = t18 * (t2 * t8 - t13);
    t28 = t7 * t1;
    t29 = t18 * t3;
    t30 = t29 * (-t28 + t17);
    t31 = t30 + t27;
    t10 = -x4 + t10;
    t32 = -t5 * t6 + 0.1e1;
    t33 = t6 * t4;
    t34 = t16 * t4;
    t35 = t7 * t33 * t32;
    t36 = t19 * (t34 + t10);
    t37 = t36 + t35;
    t12 = t18 * (t12 + t13);
    t30 = -t30 + t12;
    t34 = t19 * (-t34 - t11);
    t38 = t34 - t35;
    t39 = t15 * t6 * t14;
    t40 = t39 * t4;
    t21 = t40 * t21;
    t41 = t2 * t6;
    t42 = t41 * t32;
    t23 = -0.2e1 * t23 * t1 * t32;
    t20 = -t24 + t20;
    t43 = -t23;
    t44 = t3 * t13;
    t45 = t6 * (t6 * (-t5 * t8 + t44) + t8);
    t41 = t7 * t33 * (-t41 * t3 + 0.1e1);
    t46 = t39 * t5 * t3;
    t47 = t46 - t41 - t45;
    t15 = t10 * t6 * t32 + t15 * t18;
    t48 = pow(t4, 0.2e1);
    t16 = t16 * t1;
    t2 = t7 * t2;
    t7 = t14 * t48;
    t14 = t7 * (t16 + t2) - t15;
    t5 = t6 * (t6 * (-t5 * t9 - t44) + t9);
    t49 = -t46 + t41 - t5;
    t50 = -t11 * t6 * t32;
    t32 = -0.2e1 * t18 * t13 * t32;
    t51 = t7 * t2;
    t52 = -t51 - t32 - t50;
    t22 = t24 - t22;
    t24 = t29 * (t28 + t17);
    t27 = -t24 - t27;
    t28 = -t36 + t35;
    t12 = t24 - t12;
    t24 = -t34 - t35;
    t34 = -t46 - t41 + t45;
    t2 = t7 * (-t16 + t2) + t15;
    t5 = t46 + t41 + t5;
    t15 = -t51 + t32 + t50;
    t16 = t44 * t6;
    t32 = t10 * t3;
    t35 = t4 * t8;
    t36 = t39 * t48 * t3;
    t41 = t36 + t18 * (t32 + t35);
    t40 = -t40 * pow(t3, 0.2e1) - t29 * (-t9 + t8);
    t3 = -t11 * t3;
    t35 = -t36 + t33 * (t6 * (t3 - t35) + 0.1e1);
    t13 = t33 * t13;
    t44 = t4 * t9;
    t6 = -t36 - t33 * (t6 * (-t44 + t32) + 0.1e1);
    t4 = -t39 * t4 * t48 - t7 * (t10 + t11);
    t3 = t36 - t18 * (t3 + t44);
    hessX_c[0][0] = t19 * (t17 - t1);
    hessX_c[0][1] = t25;
    hessX_c[0][2] = -t21;
    hessX_c[0][3] = t26;
    hessX_c[0][4] = t31;
    hessX_c[0][5] = t37;
    hessX_c[0][6] = t30;
    hessX_c[0][7] = t38;
    hessX_c[1][0] = t25;
    hessX_c[1][1] = t23 - t42;
    hessX_c[1][2] = t20;
    hessX_c[1][3] = t43;
    hessX_c[1][4] = t47;
    hessX_c[1][5] = t14;
    hessX_c[1][6] = t49;
    hessX_c[1][7] = t52;
    hessX_c[2][0] = -t21;
    hessX_c[2][1] = t20;
    hessX_c[2][2] = t19 * (t17 + t1);
    hessX_c[2][3] = t22;
    hessX_c[2][4] = t27;
    hessX_c[2][5] = t28;
    hessX_c[2][6] = t12;
    hessX_c[2][7] = t24;
    hessX_c[3][0] = t26;
    hessX_c[3][1] = t43;
    hessX_c[3][2] = t22;
    hessX_c[3][3] = t23 + t42;
    hessX_c[3][4] = t34;
    hessX_c[3][5] = t2;
    hessX_c[3][6] = t5;
    hessX_c[3][7] = t15;
    hessX_c[4][0] = t31;
    hessX_c[4][1] = t47;
    hessX_c[4][2] = t27;
    hessX_c[4][3] = t34;
    hessX_c[4][4] = 0.2e1 * t29 * (t16 + t8);
    hessX_c[4][5] = t41;
    hessX_c[4][6] = t40;
    hessX_c[4][7] = t35;
    hessX_c[5][0] = t37;
    hessX_c[5][1] = t14;
    hessX_c[5][2] = t28;
    hessX_c[5][3] = t2;
    hessX_c[5][4] = t41;
    hessX_c[5][5] = 0.2e1 * t7 * (t13 + t10);
    hessX_c[5][6] = t6;
    hessX_c[5][7] = t4;
    hessX_c[6][0] = t30;
    hessX_c[6][1] = t49;
    hessX_c[6][2] = t12;
    hessX_c[6][3] = t5;
    hessX_c[6][4] = t40;
    hessX_c[6][5] = t6;
    hessX_c[6][6] = 0.2e1 * t29 * (t16 - t9);
    hessX_c[6][7] = t3;
    hessX_c[7][0] = t38;
    hessX_c[7][1] = t52;
    hessX_c[7][2] = t24;
    hessX_c[7][3] = t15;
    hessX_c[7][4] = t35;
    hessX_c[7][5] = t4;
    hessX_c[7][6] = t3;
    hessX_c[7][7] = 0.2e1 * t7 * (t13 + t11);

    t1 = y4 - y3;
    t2 = x4 - x3;
    t3 = v2x - v1x;
    t4 = v2y - v1y;
    t5 = t2 * t3;
    t6 = t1 * t4 + t5;
    t7 = 0.1e1 / 0.2e1;
    t8 = t7 * (v1y + v2y);
    t9 = -y3 + t8;
    t10 = t7 * (v1x + v2x);
    t11 = t10 - x3;
    t12 = -t1 * t11 + t2 * t9;
    t6 = 0.1e1 / t6;
    t13 = t5 * t6;
    t14 = -0.1e1 + t13;
    t15 = t1 * t6;
    t16 = t15 * t14;
    t17 = pow(t6, 0.2e1);
    t18 = t6 * t17;
    t19 = t12 * t17;
    t20 = 0.2e1 * t19 * t2 * t14;
    t21 = pow(t2, 0.2e1);
    t22 = pow(t1, 0.2e1);
    t23 = t7 * t6 * ((t22 - t21) * t6 * t3 + t2);
    t13 = t19 * t1 * (0.1e1 - 0.2e1 * t13);
    t24 = t23 + t13;
    t21 = t7 * t6 * ((-t22 - t21) * t6 * t3 + t2);
    t25 = t21 - t13;
    t8 = y4 - t8;
    t19 = t19 * t3;
    t26 = -t8 * t6 * t14;
    t27 = pow(t3, 0.2e1);
    t28 = 0.2e1 * t19 * t14;
    t29 = t7 * t1;
    t30 = t29 * t17 * t27;
    t31 = t26 - t28 + t30;
    t10 = -x4 + t10;
    t32 = t6 * t3;
    t33 = t4 * t12;
    t34 = t6 * (t6 * (-t5 * t10 + t33) + t10);
    t35 = t7 * t32 * (t15 * t4 - 0.1e1);
    t36 = 0.2e1 * t33 * t5 * t18;
    t37 = t34 + t35 - t36;
    t19 = -t9 * t6 * t14 - 0.2e1 * t19;
    t38 = 0.2e1 * t12;
    t39 = t38 * t6 * t2;
    t40 = t17 * t27;
    t41 = t19 + t40 * (t39 - t29);
    t5 = t6 * (t6 * (t5 * t11 - t33) - t11);
    t42 = t5 - t35 + t36;
    t15 = t38 * t15;
    t43 = t1 * t17 * t3;
    t21 = -t21 - t13;
    t44 = t38 * t32;
    t14 = -t7 * t32 * t14;
    t45 = t43 * (t8 + t44);
    t46 = t14 - t45;
    t17 = t17 * t3;
    t47 = t17 * (t1 * t10 - t12);
    t7 = t7 * t2;
    t48 = t17 * t4;
    t49 = t48 * (t15 + t7);
    t50 = -t47 - t49;
    t44 = t43 * (-t9 + t44);
    t51 = -t14 + t44;
    t1 = t17 * (-t1 * t11 + t12);
    t49 = -t1 + t49;
    t38 = t38 * t18;
    t52 = t38 * t3;
    t22 = t52 * t22;
    t13 = -t23 + t13;
    t23 = -t26 + t28 + t30;
    t26 = -t34 + t35 + t36;
    t19 = -t19 - t40 * (t39 + t29);
    t5 = -t5 - t35 - t36;
    t28 = t14 + t45;
    t7 = t48 * (t15 - t7);
    t29 = t47 + t7;
    t14 = -t14 - t44;
    t1 = t1 - t7;
    t7 = t32 * t12;
    t12 = t10 * t3;
    t30 = t8 * t4;
    t18 = 0.2e1 * t33 * t18 * t27;
    t34 = -t17 * (t12 + t30) - t18;
    t27 = t40 * (-t9 + t8) + t38 * t3 * t27;
    t3 = -t11 * t3;
    t30 = -t32 * (t6 * (-t30 + t3) + 0.1e1) + t18;
    t33 = t33 * t6;
    t35 = t9 * t4;
    t6 = t32 * (t6 * (t12 - t35) + 0.1e1) + t18;
    t4 = t48 * (t10 + t11) + t52 * pow(t4, 0.2e1);
    t3 = t17 * (t3 + t35) - t18;
    hessY_c[0][0] = t16 - t20;
    hessY_c[0][1] = t24;
    hessY_c[0][2] = t20;
    hessY_c[0][3] = t25;
    hessY_c[0][4] = t31;
    hessY_c[0][5] = t37;
    hessY_c[0][6] = t41;
    hessY_c[0][7] = t42;
    hessY_c[1][0] = t24;
    hessY_c[1][1] = -t43 * (t2 + t15);
    hessY_c[1][2] = t21;
    hessY_c[1][3] = t22;
    hessY_c[1][4] = t46;
    hessY_c[1][5] = t50;
    hessY_c[1][6] = t51;
    hessY_c[1][7] = t49;
    hessY_c[2][0] = t20;
    hessY_c[2][1] = t21;
    hessY_c[2][2] = -t16 - t20;
    hessY_c[2][3] = t13;
    hessY_c[2][4] = t23;
    hessY_c[2][5] = t26;
    hessY_c[2][6] = t19;
    hessY_c[2][7] = t5;
    hessY_c[3][0] = t25;
    hessY_c[3][1] = t22;
    hessY_c[3][2] = t13;
    hessY_c[3][3] = t43 * (t2 - t15);
    hessY_c[3][4] = t28;
    hessY_c[3][5] = t29;
    hessY_c[3][6] = t14;
    hessY_c[3][7] = t1;
    hessY_c[4][0] = t31;
    hessY_c[4][1] = t46;
    hessY_c[4][2] = t23;
    hessY_c[4][3] = t28;
    hessY_c[4][4] = -0.2e1 * t40 * (t8 + t7);
    hessY_c[4][5] = t34;
    hessY_c[4][6] = t27;
    hessY_c[4][7] = t30;
    hessY_c[5][0] = t37;
    hessY_c[5][1] = t50;
    hessY_c[5][2] = t26;
    hessY_c[5][3] = t29;
    hessY_c[5][4] = t34;
    hessY_c[5][5] = -0.2e1 * t48 * (t10 + t33);
    hessY_c[5][6] = t6;
    hessY_c[5][7] = t4;
    hessY_c[6][0] = t41;
    hessY_c[6][1] = t51;
    hessY_c[6][2] = t19;
    hessY_c[6][3] = t14;
    hessY_c[6][4] = t27;
    hessY_c[6][5] = t6;
    hessY_c[6][6] = -0.2e1 * t40 * (-t9 + t7);
    hessY_c[6][7] = t3;
    hessY_c[7][0] = t42;
    hessY_c[7][1] = t49;
    hessY_c[7][2] = t5;
    hessY_c[7][3] = t1;
    hessY_c[7][4] = t30;
    hessY_c[7][5] = t4;
    hessY_c[7][6] = t3;
    hessY_c[7][7] = -0.2e1 * t48 * (t11 + t33);
    // @formatter:on

    hessX = Eigen::Map<Eigen::MatrixXd>(&hessX_c[0][0], n, n);
    hessY = Eigen::Map<Eigen::MatrixXd>(&hessY_c[0][0], n, n);
}
